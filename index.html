<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrace na informační schůzku</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
    line-height: 1.6;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    animation: fadeInUp 0.8s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-header {
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    color: white;
    padding: 40px 30px;
    text-align: center;
    transition: background 0.3s ease;
}

/* Oranžová hlavička pro zkrácený formulář */
.form-header.orange {
    background: linear-gradient(135deg, #ff8c42 0%, #e67e22 100%);
}

.form-header h1 {
    font-size: 2.2em;
    font-weight: 600;
    margin-bottom: 10px;
}

.form-header p {
    font-size: 1.1em;
    opacity: 0.9;
}

.registration-form {
    padding: 40px 30px;
}

.form-section {
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #e8f4f8;
}

.form-section h3 {
    color: #2c3e50;
    font-size: 1.4em;
    margin-bottom: 20px;
    font-weight: 600;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 25px;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.95em;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: #fafbfc;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #4a90e2;
    background: white;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    transform: translateY(-1px);
}

.form-group input:hover,
.form-group select:hover {
    border-color: #b8d4f1;
    background: white;
}

.form-group select:disabled {
    background-color: #f5f5f5;
    color: #999;
    cursor: not-allowed;
}

.form-actions {
    margin-top: 40px;
    text-align: center;
}

.submit-btn {
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    color: white;
    border: none;
    padding: 16px 40px;
    font-size: 1.1em;
    font-weight: 600;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 200px;
    position: relative;
    overflow: hidden;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(74, 144, 226, 0.3);
}

.submit-btn:active {
    transform: translateY(0);
}

.submit-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-loading {
    display: inline-block;
}

.btn-loading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
    margin-left: 10px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.success-message,
.error-message {
    margin: 30px;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    animation: slideIn 0.5s ease-out;
}

.success-message {
    background: linear-gradient(135deg, #00c851 0%, #00a041 100%);
    color: white;
}

.error-message {
    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
    color: white;
}

.success-message h3,
.error-message h3 {
    font-size: 1.3em;
    margin-bottom: 10px;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Skrytí sekce termínů */
.form-section.hidden {
    display: none;
}

/* Responsive design */
@media (max-width: 768px) {
    .container {
        margin: 10px;
        border-radius: 15px;
    }
    
    .form-header {
        padding: 30px 20px;
    }
    
    .form-header h1 {
        font-size: 1.8em;
    }
    
    .registration-form {
        padding: 30px 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 0;
    }
    
    .success-message,
    .error-message {
        margin: 20px;
        padding: 20px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 10px;
    }
    
    .form-header h1 {
        font-size: 1.5em;
    }
    
    .form-header p {
        font-size: 1em;
    }
    
    .submit-btn {
        width: 100%;
        padding: 14px 20px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="form-header" id="formHeader">
            <h1 id="headerTitle">Registrace na informační schůzku</h1>
            <p id="headerSubtitle">Projekt: Podpora zapojení osob ukrajinské národnosti na trhu práce II</p>
        </div>

        <form id="registrationForm" class="registration-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="jmeno">Jméno *</label>
                    <input type="text" id="jmeno" name="jmeno" required>
                </div>
                <div class="form-group">
                    <label for="prijmeni">Příjmení *</label>
                    <input type="text" id="prijmeni" name="prijmeni" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="telefon">Telefon *</label>
                    <input type="tel" id="telefon" name="telefon" required>
                </div>
                <div class="form-group">
                    <label for="mail">Email *</label>
                    <input type="email" id="mail" name="mail" required>
                </div>
            </div>

            <div class="form-group">
                <label for="docasna_ochrana">Máte v České republice udělenou dočasnou ochranu? *</label>
                <select id="docasna_ochrana" name="docasna_ochrana" required>
                    <option value="">-- Vyberte možnost --</option>
                    <option value="ANO">ANO</option>
                    <option value="NE">NE</option>
                    <option value="Jiné">Jiné</option>
                </select>
            </div>

            <div class="form-group">
                <label for="registrace">Jste registrován/a na úřadu práce? *</label>
                <select id="registrace" name="registrace" required>
                    <option value="">-- Vyberte možnost --</option>
                    <option value="ANO">ANO</option>
                    <option value="NE">NE</option>
                    <option value="Jiné">Jiné</option>
                </select>
            </div>

            <div class="form-group">
                <label for="prace">Máte v České republice nyní zaměstnání? *</label>
                <select id="prace" name="prace" required>
                    <option value="">-- Vyberte možnost --</option>
                    <option value="Ne">Ne, nyní nemám zaměstnání, nepracuji</option>
                    <option value="Ano, pracuji, mám PS">Ano, pracuji, mám Pracovní smlouvu</option>
                    <option value="Ano, pracuji a mám DPP nebo DPČ">Ano, pracuji a mám Dohodu o provedení práce nebo Dohodu o pracovní činnosti</option>
                    <option value="Jiné">Jiné</option>
                </select>
            </div>

            <div class="form-section" id="dateSection">
                <h3>Výběr termínu schůzky</h3>
                
                <div class="form-group">
                    <label for="datum">Datum *</label>
                    <select id="datum" name="datum" required>
                        <option value="">-- Načítání dostupných termínů... --</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cas">Čas *</label>
                        <select id="cas" name="cas" required disabled>
                            <option value="">-- Nejprve vyberte datum --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="misto">Místo *</label>
                        <select id="misto" name="misto" required disabled>
                            <option value="">-- Nejprve vyberte datum --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" id="submitBtn" class="submit-btn">
                    <span class="btn-text" id="btnText">Odeslat registraci</span>
                    <span class="btn-loading" style="display: none;">Odesílání...</span>
                </button>
            </div>
        </form>

        <div id="successMessage" class="success-message" style="display: none;">
            <h3>✓ <span id="successTitle">Registrace byla úspěšná!</span></h3>
            <p id="successText">Na váš email byl odeslán potvrzovací email s podrobnostmi o schůzce.</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
            <h3>✗ Chyba při registraci</h3>
            <p id="errorText"></p>
        </div>
    </div>

    <script>
let isInterestOnlyMode = false; // Globální proměnná pro sledování režimu

document.addEventListener('DOMContentLoaded', function() {
    // Načteme dostupné termíny při načtení stránky
    loadAvailableDates();
    
    // Event listener pro změnu datumu
    document.getElementById('datum').addEventListener('change', onDateChange);
    
    // Event listener pro změnu času
    document.getElementById('cas').addEventListener('change', onTimeChange);
    
    // Event listener pro odeslání formuláře
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm();
    });
});

// Načtení dostupných termínů
function loadAvailableDates() {
    const datumSelect = document.getElementById('datum');
    datumSelect.innerHTML = '<option value="">-- Načítání... --</option>';
    
    google.script.run
        .withSuccessHandler(function(datesWithDetails) {
            if (datesWithDetails.length === 0) {
                // Žádné termíny - přepneme na zkrácený formulář
                switchToInterestOnlyMode();
            } else {
                // Máme termíny - zobrazíme plný formulář
                switchToFullMode();
                datumSelect.innerHTML = '<option value="">-- Vyberte datum --</option>';
                datesWithDetails.forEach(function(dateObj) {
                    const option = document.createElement('option');
                    option.value = dateObj.date;
                    option.textContent = dateObj.date;
                    // Uložíme dodatečné informace jako data atributy
                    option.setAttribute('data-auto-fill', dateObj.autoFill);
                    if (dateObj.autoFill) {
                        option.setAttribute('data-time', dateObj.time);
                        if (dateObj.place) {
                            option.setAttribute('data-place', dateObj.place);
                        }
                    }
                    datumSelect.appendChild(option);
                });
            }
        })
        .withFailureHandler(function(error) {
            console.error('Chyba při načítání termínů:', error);
            datumSelect.innerHTML = '<option value="">-- Chyba při načítání --</option>';
            showError('Nepodařilo se načíst dostupné termíny. Zkuste obnovit stránku.');
        })
        .getAvailableDates();
}

// Přepnutí na zkrácený formulář (bez termínů)
function switchToInterestOnlyMode() {
    isInterestOnlyMode = true;
    
    // Změníme hlavičku na oranžovou
    const header = document.getElementById('formHeader');
    header.classList.add('orange');
    
    // Změníme text hlavičky
    document.getElementById('headerTitle').textContent = 'Zájem o projekt';
    document.getElementById('headerSubtitle').textContent = 'V současné době není vypsán termín hromadné informační schůzky. Pokud máte zájem o účast v projektu, vyplňte níže uvedené údaje a my vás budeme kontaktovat.';
    
    // Skryjeme sekci s termíny
    const dateSection = document.getElementById('dateSection');
    dateSection.classList.add('hidden');
    
    // Změníme text tlačítka
    document.getElementById('btnText').textContent = 'Odeslat zájem o kontakt';
    
    // Odebereme required atributy z polí termínů
    document.getElementById('datum').removeAttribute('required');
    document.getElementById('cas').removeAttribute('required');
    document.getElementById('misto').removeAttribute('required');
}

// Přepnutí na plný formulář (s termíny)
function switchToFullMode() {
    isInterestOnlyMode = false;
    
    // Vrátíme modrou hlavičku
    const header = document.getElementById('formHeader');
    header.classList.remove('orange');
    
    // Vrátíme původní text hlavičky
    document.getElementById('headerTitle').textContent = 'Registrace na informační schůzku';
    document.getElementById('headerSubtitle').textContent = 'Projekt: Podpora zapojení osob ukrajinské národnosti na trhu práce II';
    
    // Zobrazíme sekci s termíny
    const dateSection = document.getElementById('dateSection');
    dateSection.classList.remove('hidden');
    
    // Vrátíme text tlačítka
    document.getElementById('btnText').textContent = 'Odeslat registraci';
    
    // Přidáme required atributy zpět
    document.getElementById('datum').setAttribute('required', '');
    document.getElementById('cas').setAttribute('required', '');
    document.getElementById('misto').setAttribute('required', '');
}

// Funkce pro změnu datumu
function onDateChange() {
    const selectedDate = document.getElementById('datum').value;
    const casSelect = document.getElementById('cas');
    const mistoSelect = document.getElementById('misto');
    
    if (!selectedDate) {
        resetTimeAndPlace();
        return;
    }
    
    // Získáme vybranou option pro kontrolu auto-fill
    const selectedOption = document.querySelector('#datum option[value="' + selectedDate + '"]');
    const autoFill = selectedOption ? selectedOption.getAttribute('data-auto-fill') === 'true' : false;
    
    if (autoFill) {
        // Automatické vyplnění času a případně místa
        const autoTime = selectedOption.getAttribute('data-time');
        const autoPlace = selectedOption.getAttribute('data-place');
        
        casSelect.innerHTML = `<option value="${autoTime}">${autoTime}</option>`;
        casSelect.value = autoTime;
        casSelect.disabled = true;
        
        if (autoPlace) {
            // Jedno místo - automatické vyplnění
            mistoSelect.innerHTML = `<option value="${autoPlace}">${autoPlace}</option>`;
            mistoSelect.value = autoPlace;
            mistoSelect.disabled = true;
        } else {
            // Více míst - načteme je
            loadPlacesForDateTime(selectedDate, autoTime);
        }
    } else {
        // Více termínů - načteme časy
        loadTimesForDate(selectedDate);
    }
}

// Funkce pro změnu času
function onTimeChange() {
    const selectedDate = document.getElementById('datum').value;
    const selectedTime = document.getElementById('cas').value;
    
    if (!selectedDate || !selectedTime) {
        resetPlace();
        return;
    }
    
    loadPlacesForDateTime(selectedDate, selectedTime);
}

// Načtení časů pro vybraný termín (pouze pro případy s více termíny)
function loadTimesForDate(selectedDate) {
    const casSelect = document.getElementById('cas');
    const mistoSelect = document.getElementById('misto');
    
    // Resetujeme čas a místo
    casSelect.innerHTML = '<option value="">-- Načítání... --</option>';
    casSelect.disabled = true;
    resetPlace();
    
    google.script.run
        .withSuccessHandler(function(timesResult) {
            if (Array.isArray(timesResult)) {
                // Více termínů - zobrazit výběr času
                casSelect.innerHTML = '<option value="">-- Vyberte čas --</option>';
                timesResult.forEach(function(time) {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    casSelect.appendChild(option);
                });
                casSelect.disabled = false;
            } else {
                // Jeden termín - automatické vyplnění (toto by se nemělo stát díky nové logice)
                casSelect.innerHTML = `<option value="${timesResult.autoFillTime}">${timesResult.autoFillTime}</option>`;
                casSelect.value = timesResult.autoFillTime;
                casSelect.disabled = true;
                
                if (timesResult.autoFillPlace) {
                    mistoSelect.innerHTML = `<option value="${timesResult.autoFillPlace}">${timesResult.autoFillPlace}</option>`;
                    mistoSelect.value = timesResult.autoFillPlace;
                    mistoSelect.disabled = true;
                } else {
                    loadPlacesForDateTime(selectedDate, timesResult.autoFillTime);
                }
            }
        })
        .withFailureHandler(function(error) {
            console.error('Chyba při načítání časů:', error);
            casSelect.innerHTML = '<option value="">-- Chyba při načítání --</option>';
            showError('Nepodařilo se načíst dostupné časy pro vybraný termín.');
        })
        .getTimesForDate(selectedDate);
}

// Načtení míst pro vybraný termín a čas
function loadPlacesForDateTime(selectedDate, selectedTime) {
    const mistoSelect = document.getElementById('misto');
    
    // Resetujeme a zakážeme select místa
    mistoSelect.innerHTML = '<option value="">-- Načítání... --</option>';
    mistoSelect.disabled = true;
    
    google.script.run
        .withSuccessHandler(function(places) {
            if (places.length === 1) {
                // Pouze jedno místo - automatické vyplnění
                mistoSelect.innerHTML = `<option value="${places[0]}">${places[0]}</option>`;
                mistoSelect.value = places[0];
                mistoSelect.disabled = true;
            } else {
                // Více míst - zobrazit výběr
                mistoSelect.innerHTML = '<option value="">-- Vyberte místo --</option>';
                places.forEach(function(place) {
                    const option = document.createElement('option');
                    option.value = place;
                    option.textContent = place;
                    mistoSelect.appendChild(option);
                });
                mistoSelect.disabled = false;
            }
        })
        .withFailureHandler(function(error) {
            console.error('Chyba při načítání míst:', error);
            mistoSelect.innerHTML = '<option value="">-- Chyba při načítání --</option>';
            showError('Nepodařilo se načíst dostupná místa pro vybraný termín a čas.');
        })
        .getPlacesForDateTime(selectedDate, selectedTime);
}

// Reset času a místa
function resetTimeAndPlace() {
    const casSelect = document.getElementById('cas');
    const mistoSelect = document.getElementById('misto');
    
    casSelect.innerHTML = '<option value="">-- Nejprve vyberte datum --</option>';
    casSelect.disabled = true;
    
    resetPlace();
}

// Reset pouze místa
function resetPlace() {
    const mistoSelect = document.getElementById('misto');
    
    mistoSelect.innerHTML = '<option value="">-- Nejprve vyberte čas --</option>';
    mistoSelect.disabled = true;
}

// Odeslání formuláře
function submitForm() {
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    // Validace formuláře - pro zkrácený formulář přeskočíme validaci termínů
    if (!isInterestOnlyMode && !form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Pro zkrácený formulář validujeme pouze základní pole
    if (isInterestOnlyMode) {
        const requiredFields = ['jmeno', 'prijmeni', 'telefon', 'mail', 'docasna_ochrana', 'registrace', 'prace'];
        let isValid = true;
        
        for (let fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                isValid = false;
                field.focus();
                break;
            }
        }
        
        if (!isValid) {
            showError('Prosím vyplňte všechna povinná pole.');
            return;
        }
    }
    
    // Zakážeme tlačítko a zobrazíme loading
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-block';
    
    // Skryjeme předchozí zprávy
    hideMessages();
    
    // Sebereme data z formuláře
    const formData = {
        jmeno: document.getElementById('jmeno').value.trim(),
        prijmeni: document.getElementById('prijmeni').value.trim(),
        telefon: document.getElementById('telefon').value.trim(),
        mail: document.getElementById('mail').value.trim(),
        docasna_ochrana: document.getElementById('docasna_ochrana').value,
        registrace: document.getElementById('registrace').value,
        prace: document.getElementById('prace').value,
        datum: isInterestOnlyMode ? '' : document.getElementById('datum').value,
        cas: isInterestOnlyMode ? '' : document.getElementById('cas').value,
        misto: isInterestOnlyMode ? '' : document.getElementById('misto').value
    };
    
    // Odešleme data
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showSuccess();
                form.reset();
                if (!isInterestOnlyMode) {
                    resetTimeAndPlace();
                    loadAvailableDates(); // Znovu načteme termíny
                }
            } else {
                showError(result.message);
            }
            resetSubmitButton();
        })
        .withFailureHandler(function(error) {
            console.error('Chyba při odesílání:', error);
            showError('Došlo k neočekávané chybě. Zkuste to prosím znovu.');
            resetSubmitButton();
        })
        .saveRegistration(formData);
}

// Reset tlačítka po odeslání
function resetSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    submitBtn.disabled = false;
    btnText.style.display = 'inline-block';
    btnLoading.style.display = 'none';
}

// Zobrazení úspěšné zprávy - BEZ automatického návratu
function showSuccess() {
    const successDiv = document.getElementById('successMessage');
    const successTitle = document.getElementById('successTitle');
    const successText = document.getElementById('successText');
    const form = document.getElementById('registrationForm');
    
    if (isInterestOnlyMode) {
        successTitle.textContent = 'Zájem byl úspěšně odeslán!';
        successText.textContent = 'Děkujeme za váš zájem. Na váš email byl odeslán potvrzovací email a my se vám brzy ozveme.';
    } else {
        successTitle.textContent = 'Registrace byla úspěšná!';
        successText.textContent = 'Na váš email byl odeslán potvrzovací email s podrobnostmi o schůzce.';
    }
    
    form.style.display = 'none';
    successDiv.style.display = 'block';
    
    // Scroll nahoru
    successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // ODEBRÁN automatický návrat na formulář - hláška zůstane zobrazená
}

// Zobrazení chybové zprávy
function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    
    errorText.textContent = message;
    errorDiv.style.display = 'block';
    
    // Scroll k chybě
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Automaticky skryjeme po 8 sekundách
    setTimeout(function() {
        errorDiv.style.display = 'none';
    }, 8000);
}

// Skrytí všech zpráv
function hideMessages() {
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
}
    </script>
</body>
</html>
